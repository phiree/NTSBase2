-- DROP PROCEDURE up_GenerateProductCode;
DELIMITER $$

CREATE PROCEDURE up_GenerateProductCode()
BEGIN
DECLARE done INT  DEFAULT FALSE;
DECLARE c VARCHAR(50);
DECLARE sKey VARCHAR(10);
DECLARE sNo INT;
DECLARE cur1 CURSOR FOR SELECT ntscode FROM product ;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done =TRUE;
OPEN cur1;
read_loop:LOOP
FETCH cur1 INTO c;
 IF done THEN LEAVE read_loop; END IF;

SET sKey= REPLACE(LEFT(c,6),'.','');
SELECT sKey;
  IF NOT EXISTS(SELECT * FROM formatserialno WHERE SerialKey=sKey)
  THEN
	UPDATE product SET productcode=CONCAT(sKey,'00001') WHERE ntscode=c;
	INSERT INTO formatserialno (id,serialkey,serialno) VALUES(UUID(), sKey,1);
  ELSE
	UPDATE product SET productcode=CONCAT(sKey,RIGHT(CONCAT('00000',sNo+1),5)) WHERE ntscode=c;
	SELECT SerialNo FROM formatserialno WHERE serialkey=sKey INTO sNo;
	UPDATE formatserialno SET serialno=sNo+1 WHERE serialkey=sKey;	
  END IF;
END LOOP;
CLOSE cur1;
END $$
DELIMITER;
CALL up_GenerateProductCode;
SELECT * FROM product ORDER BY productcode 
--  
 SELECT * FROM formatserialno WHERE LENGTH(serialkey)<=5
-- delete from formatserialno
-- update product set  productcode=null 
UPDATE product SET  productcode='aaa' WHERE  id='b52d81d6-a229-40ce-9a97-a28101098423'